<!DOCTYPE html>
<html lang="en">
<head>
  <title>runJS</title>
  <body>
    <button onclick="runCode();">Run</button>
    <input id="save-svg" type="button" value="Save as SVG"/>

    <button id="save-png">Save as PNG</button>
    
    <br/>
    <div id="errorOutput"></div>
    
    <textarea rows="20" cols="50" id="codeEditor"></textarea>
    
    <div id="result">
    </div>

    <div id="chartOutput" style="width: 600px; height: 400px;"></div>

<script src="https://www.gstatic.com/charts/loader.js"></script>

<script id="codeSnippet" type="text/code-snippet">

let data0 = [['x','y0'],[1,2],[1,2.5], [2,2.1], [2,2.9], [3,3.2]  ];
let data1 = [['x','y1'],[1,2.4],[2,2.9] ];
let data2 = [['x','y2'],[1.5,1.8] ];
let data3 = [['x','y3'],[0.5,1.5],[1,1.4],[1.5,4.0],[2.0,5.0],[3.0,4.5],[3.5,1.0] ];

let d0 = google.visualization.arrayToDataTable( data0 );
let d1 = google.visualization.arrayToDataTable( data1 );
let d2 = google.visualization.arrayToDataTable( data2 );
let d3 = google.visualization.arrayToDataTable( data3 );

var p = new google.visualization.DataTable();
p.addColumn('number', 'x');
p.addColumn('number', 'text');
p.addColumn({type: 'string', role: 'annotation'});
p.addRow([2.5, 0.8, 'bla']);

let d01 = google.visualization.data.join( d0, d1, 'full', [[0,0]],[1],[1]);
let d012 = google.visualization.data.join( d01, d2, 'full', [[0,0]],[1,2],[1]);
let d0123 = google.visualization.data.join( d012, d3, 'full', [[0,0]],[1,2,3],[1]);
let d = google.visualization.data.join( d0123, p, 'full', [[0,0]],[1,2,3,4],[1,2]);


var data = google.visualization.arrayToDataTable([
 ['x', 'y0', 'y1', 'y2', 'y3'],
 [ 1 , 2, 3, 4, null ],
 [ 1 , 2.5, 3.1, null, 4.5 ],
 [ 2 , 2.5, 3.4, 2.2, 5 ],
 [ 2 , 2.5, 3.4, null, null ],
 [ 3 , 1.75, 3.4, 3.9, 0.5 ],

]);

var options = {
  title : 'My title',
  vAxis: {title: 'distance (m)'},
  hAxis: {title: '\u0394time (s)', minValue: 0, maxValue: 4},
  seriesType: 'scatter',
  series: {1: {type: 'line'}, 3: {type: 'line', curveType: 'function'}, 
               4: {pointSize: 0, annotations: { stemColor : 'none' }} },
  interpolateNulls: true,
};

options.hAxis.titleTextStyle = {italic: false };
options.vAxis.titleTextStyle = {italic: false };
options.vAxis.gridlines= {count: 50, multiple: 1};
options.hAxis.gridlines= {count: 20, multiple: 0.5};



// Always needed
let chart = new google.visualization.ComboChart( chartOutput );
chart.draw(d, options);
chart;

</script>
        
    <script>
      let errorOutput = document.getElementById('errorOutput');
      let chartOutput = document.getElementById('chartOutput');
      let base64 = "";


      loadCode('codeSnippet', 'codeEditor');
      
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback( runCode );
      
      //runCode('codeEditor');
      
      function loadCode(scriptId, textAreaId) {
        let scriptNode = document.getElementById(scriptId);
        let textArea = document.getElementById(textAreaId);
        if (scriptNode.type !== 'text/code-snippet') {
            throw Error('Unknown code snippet type');
        }
        textArea.value = scriptNode.text.replace(/^\n/, '');
      };


      
      function runCode() {
        try {
            clearError();
            let code = document.getElementById('codeEditor').value;
            let chart = eval(code);

            //chartPNG.innerHTML = '<img src="' + chart.getImageURI() + '">';
            base64 = chart.getImageURI();
          
        } catch (err) {
            printError(err);
        }
      }
      
    function clearError() {
        errorOutput.innerHTML = '';
    };

    function printError(err) {
        errorOutput.innerHTML = err;
    };

      
    document.getElementById('save-svg').addEventListener('click', function () {

      //get svg element.
      var svg = chartOutput.getElementsByTagName('svg')[0];

      //get svg source.
      var serializer = new XMLSerializer();
      var source = serializer.serializeToString(svg);

      //add name spaces.
      if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
        source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
      }
      if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
        source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
      }

      //add xml declaration
      source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

      //convert svg source to URI data scheme.
      var url = "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(source);

      downloadURL( url, "chart.svg" );
      
    });

      
  document.getElementById('save-png').addEventListener('click', function () {
    downloadURL( base64, "chart.png" );
  });

  function downloadURL( url, fileName ) {
    var link = document.createElement("a");
    document.body.appendChild(link); // for Firefox
    link.setAttribute("href", url);
    link.setAttribute("download", fileName );
    link.click();
    document.body.removeChild(link);
  }
      
    </script>


</body>
</html>
