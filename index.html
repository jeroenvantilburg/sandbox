<!DOCTYPE html>
<html lang="en">
<head>
    <script src="scripts/fabric.min.js"></script>
    <!--script src="beep.js"></script-->
</head>
  <body>
<div style="position:relative;width:500px;height:500px">
    <canvas id="c" width="500" height="500" style="border:1px solid #ccc"></canvas>
</div>

<audio id="myAudio">
  <source src="audio/beep440Hz.ogg" type="audio/ogg">
  <source src="audio/beep440Hz.mp3" type="audio/mpeg">
  Your browser does not support the audio element.
</audio>
      

<script id="main">
(function() {

  // Mixed analog / digital
  var low = 0.0, high = 5.0, loThreshold = 0.8, hiThreshold = 1.4; // from Systeembord manual
  function isHigh(x) {return x > hiThreshold; };
  function isLow(x) {return x < loThreshold; }; 
  function invert(x) {return isHigh(x) ? low : high; }; 

  // Create canvas
  var canvas = this.__canvas = new fabric.Canvas('c', { selection: false });
  fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';

  // Make movable circle for wire
  function makeCircle(left, top, line1, node){
    var c = new fabric.Circle({
      left: left,
      top: top,
      strokeWidth: 5,
      radius: 5,
      fill: 'red',
      //stroke: '#666',
      //selectable: false,
    });
    c.hasControls = c.hasBorders = false;

    c.name = "wire";
    c.line1 = line1;
    c.node = node;
    c.connection = null;
    return c;
  }

  // Make line for wire
  function makeLine(coords) {
    return new fabric.Line(coords, {
      fill: 'red',
      stroke: 'red',
      strokeWidth: 5,
      //selectable: false,
      evented: false
    });
  }

  // Make wire (= movable circle + line + fixed circle)
  function makeWire(x1,y1,node) { 
    var circ = new fabric.Circle({left: x1, top: y1, strokeWidth: 5, radius: 5, 
                                fill: 'red', selectable: false});
    canvas.add(circ);
    var line = makeLine([ x1, y1, x1, y1 ]);
    canvas.add( line );
    canvas.add( makeCircle(x1, y1, line, node) );
  }  

  // Make a push button
  function makeButton(left, top, node){
    var c = new fabric.Circle({
      left: left,
      top: top,
      strokeWidth: 5,
      radius: 5,
      fill: 'blue',
      //stroke: '#666',
      selectable: false,
    });
    c.hasControls = c.hasBorders = false;

    c.name = "button";
    c.node = node;
    return c;
  }    
  
  // Generic input node (has a child to follow)
  function InputNode(x1,y1) { 
    this.x1 = x1;
    this.y1 = y1;
    this.child = null;
    this.eval = function() { return (this.child) ? this.child.eval() : false ; };
    this.isInput = true;
    makeWire(x1,y1,this);
  }

  // Generic output node (has a state=voltage)
  function OutputNode(x1,y1) { 
    this.x1 = x1;
    this.y1 = y1;
    this.state = low;
    this.eval = function() { return this.state; };      
    this.isInput = false;     
    makeWire(x1,y1,this);
  }    

  // AND node
  function ANDNode(x1,y1,input1,input2) { 
    this.x1 = x1;
    this.y1 = y1;
    this.child1 = input1;
    this.child2 = input2;
    this.eval = function() {
      return (this.child1 && this.child1 != this && isHigh(this.child1.eval()) &&
              this.child2 && this.child2 != this && isHigh(this.child2.eval()) ) ?
              high : low ;
    };      
    this.isInput = false;
    makeWire(x1,y1,this);
  }

  // OR node
  function ORNode(x1,y1,input1,input2) { 
    this.x1 = x1;
    this.y1 = y1;
    this.child1 = input1;
    this.child2 = input2;
    this.eval = function() {
      return ((this.child1 && this.child1 != this && isHigh(this.child1.eval())) ||  // Fix this TODO !!!!!
              (this.child2 && this.child2 != this && isHigh(this.child2.eval()))) ?
              high : low ;
    };      
    this.isInput = false;     

    makeWire(x1,y1,this);
  }

  // NOT node
  function NOTNode(x1,y1,input1) { 
    this.x1 = x1;
    this.y1 = y1;
    this.child1 = input1;
    this.eval = function() {
      return (this.child1 && this.child1 != this && isHigh(this.child1.eval())) ? low : high ;
    };      
    this.isInput = false;     

    makeWire(x1,y1,this);
  }    
  
  // Comparator node
  function ComparatorNode(x1,y1,input1) { 
    this.x1 = x1;
    this.y1 = y1;
    this.child1 = input1;
    this.compare = low;
    this.eval = function() {
      return (this.child1 && this.child1 != this && this.child1.eval() > this.compare) ? 
              high : low ;
    };      
    this.isInput = false;     

    makeWire(x1,y1,this);
  }  
    
  // Binary node
  function BinaryNode(x1,y1,input1,bin) { 
    this.x1 = x1;
    this.y1 = y1;
    this.child1 = input1;
    this.eval = function() {
      var binary = (this.child1.eval() / high ) * 15;
      var bit = (binary & (1<<bin)) >> bin;
      return (this.child1 && this.child1 != this && bit == 1 ) ? high : low ;
    };      
    this.isInput = false;     

    makeWire(x1,y1,this);
  }    


    
  // Draw the box plus text
  function drawElementBox(x1,y1,height,width,text) {
      // Draw text in box
      var textbox = new fabric.Textbox(text.toString(), {
        left: x1+50, top: y1+(height-10), width: width, fontSize: 12, textAlign: 'center', 
        selectable: true });
      canvas.add(textbox)
      textbox.sendToBack();
      // Draw box
      var r = new fabric.Rect({left: x1+0.5*width, top: y1+0.5*height, height: height, width: width, 
                               fill: 'lightgrey', selectable: false, 
                               stroke: 'black', strokeWidth: 2   });
      canvas.add(r);
      r.sendToBack();
  }
  
  // Create AND port with its nodes
  function ANDPort(x1,y1) {
      drawElementBox(x1,y1,80,100,'EN-poort');
      this.output = function() {return true;};
      let node1 = new InputNode(x1+15, y1+25 );
      let node2 = new InputNode(x1+15, y1+55 );
      let node3 = new ANDNode(x1+85, y1+40, node1, node2);
      this.nodes = [ node1, node2 , node3 ] ;
  }

  // Create OR port with its nodes
  function ORPort(x1,y1) {
      drawElementBox(x1,y1,80,100,'OF-poort');
      this.output = function() { return true; };
      let node1 = new InputNode(x1+15, y1+25 );
      let node2 = new InputNode(x1+15, y1+55 );
      let node3 = new ORNode(x1+85, y1+40, node1, node2);
      this.nodes = [ node1, node2 , node3 ] ;     
  }

  // Create NOT port with its nodes
  function NOTPort(x1,y1) {
      drawElementBox(x1,y1,40,100,'Invertor');
      this.output = function() { return true; };
      let node1 = new InputNode(x1+15, y1+20 );
      let node2 = new NOTNode(x1+85, y1+20, node1);
      this.nodes = [ node1, node2 ] ;     
  }

  // Create memory cell with its nodes
  function Memory(x1,y1) {
      drawElementBox(x1,y1,80,100,'Geheugencel');
      let node1 = new InputNode(x1+15, y1+25 );
      let node2 = new InputNode(x1+15, y1+55 );
      let node3 = new OutputNode(x1+85, y1+40);
      this.nodes = [ node1, node2, node3 ] ;     
      this.output = function() { 
          if( isHigh(node2.eval()) ) this.nodes[2].state = low;
          if( isHigh(node1.eval()) ) this.nodes[2].state = high; // set always wins
          return true;
      }
  }
    
  // Create LED with node
  function LED(x1,y1) {
      drawElementBox(x1,y1,40,100,'LED');
      
      // Draw LED
      var c = new fabric.Circle({left: x1+75, top: y1+20, radius: 5, 
                                 fill: 'darkred', selectable: false, 
                                 stroke: 'black', strokeWidth: 2   });
      canvas.add(c);

      this.nodes = [ new InputNode(x1+25, y1+20 ) ] ;    

      // Control LED behaviour
      this.output = function() {
        var result = this.nodes[0].eval();
        if( isHigh(result) ) {
          c.set({fill : 'red'});
        } else {
          c.set({fill : 'darkred'});            
        }
        return result;
      };
  }

  // Create sound output
  function Sound(x1,y1) {
      drawElementBox(x1,y1,40,100,'Zoemer');
      this.nodes = [ new InputNode(x1+25, y1+20 ) ] ;    
      this.audio = document.getElementById("myAudio"); 
      // Control LED behaviour
      this.output = function() {
        var result = this.nodes[0].eval();
        if( isHigh(result) ) {
            this.audio.play(); 	
        } else {
            this.audio.pause(); 	
        }
        return result;
      };
  }    
    
  // Create switch
  function Switch(x1,y1) {
      drawElementBox(x1,y1,40,100,'Drukschakelaar');
      this.output = function() { return true;};
      let node = new OutputNode(x1+85, y1+20 );
      this.nodes = [ node ] ;
      // Draw the push button
      canvas.add( makeButton(x1+15, y1+20, node) );
  }

  // Create an number-input DOM element
  function inputDOM(x1,y1,name,value,step,min,max){
      var input = document.createElement("input"); input.type = "number"; 
      input.id = name; 
      input.name = name;
      input.value = value; input.step = step; input.min= min; input.max= max;
      input.style = "position:absolute;width:30px";
      input.style.left = (x1).toString()+"px";
      input.style.top = (y1).toString()+"px";
      input.className = "css-class-name"; // set the CSS class
      body = document.getElementsByTagName("BODY")[0];
      body.appendChild(input); // put it into the DOM
      return input ;
  }
    
  // Create a pulse generator
  function Pulse(x1,y1) {
      drawElementBox(x1,y1,40,100,'Pulsgenerator');

      // Create unique element ID
      var elementName = "frequency"+x1.toString()+y1.toString();

      // Create an input DOM element
      var input = inputDOM(x1+30,y1+10,elementName,"1","0.1","0.5","10");

      let node = new OutputNode(x1+85, y1+20 );
      this.nodes = [ node ] ; 
      this.pulseStarted = false;
      this.output = function() {
          return true;
      };
      
      // Start the pulse generator
      this.startPulse = function() {
        node.state = invert(node.state);
        var myElement = document.getElementById(elementName);
        var _this = this;
        setTimeout(function() { _this.startPulse(); }, 500/(myElement.value));
      }
      this.startPulse();
  }    

  // Variable voltage power
  function VarVoltage(x1,y1) {
      drawElementBox(x1,y1,40,100,'Variabele spanning');
 
      // Create unique element ID
      var elementName = "voltage"+x1.toString()+y1.toString();

      // Create an input DOM element
      var input = inputDOM(x1+30,y1+10,elementName,"5","0.1","0.1","5");

      // Create an ouput node and set voltage from the DOM element
      let node = new OutputNode(x1+85, y1+20 );
      node.state = input.value;
      this.nodes = [ node ] ;     
      this.output = function() {
        this.nodes[0].state = input.value;
        return true;
      };

  }    

  // Comparator
  function Comparator(x1,y1) {
      drawElementBox(x1,y1,80,100,'Comparator');

      // Create unique element ID
      var elementName = "voltage"+x1.toString()+y1.toString();
      
      // Create an input DOM element
      var input = inputDOM(x1+35,y1+50,elementName,"2.5","0.1","0.1","5");

      // Create the node
      let node1 = new InputNode(x1+15, y1+15 );
      let node2 = new ComparatorNode(x1+85, y1+25, node1);
      node2.compare = input.value; // set compare value
      this.nodes = [ node1, node2 ] ;     
      this.output = function() {
        this.nodes[1].compare = input.value;
        return true;
      };
  }
    
  // Create ADC
  function ADC(x1,y1) {
      drawElementBox(x1,y1,40,100,'AD omzetter');
      this.output = function() { return true;};
      let node4 = new InputNode( x1+15, y1+20 );
      let node3 = new BinaryNode(x1+40, y1+20, node4, 3 );
      let node2 = new BinaryNode(x1+55, y1+20, node4, 2 );
      let node1 = new BinaryNode(x1+70, y1+20, node4, 1 );
      let node0 = new BinaryNode(x1+85, y1+20, node4, 0 );
      this.nodes = [ node4,node3,node2,node1,node0 ] ;
  }

  // Create Counter
  function Counter(x1,y1) {
      drawElementBox(x1,y1,80,200,'Pulsen teller');
      this.output = function() { return true;};
      this.nodes = [ ] ;
  }

    
    
  var elements = [new Switch(25,160),
                  new Switch(25,200),
                  new Pulse(25,240),
                  new VarVoltage(25,280),
                  new ADC(25,320),
                  //new Pulse(25,160),
                  new Comparator(125,0),
                  new Comparator(225,0),
                  new ANDPort(125,80),
                  new ANDPort(225,80),
                  new ORPort(225,160),
                  new Memory(125,160),
                  new NOTPort(125,240),
                  new NOTPort(225,240),
                  new Counter(125,280),
                  new LED(325,0), 
                  new LED(325,40), 
                  new LED(325,80), 
                  new LED(325,120),
                  new Sound(325,160)];

  // Main engine: evaluate all elements (elements evaluate the nodes)
  function evaluateBoard() {
    for (i = 0; i < elements.length; i++) { 
       elements[i].output();
    } 
    canvas.renderAll();
  }

  //alert("Your name is ");

  // Make sure that the engine is run every 50 millisecond  
  setInterval(evaluateBoard, 50);

  // Change button color and state of OutputNode when pushed
  canvas.on({'mouse:dblclick': mouseClick,
             'mouse:down':mouseClick});
  function mouseClick(e) {
    var p = e.target;
    if( !p || p.name != "button") return;
    p.node.state = invert(p.node.state);
    if( isHigh(p.node.state) ) p.set({ fill: 'darkblue'});
    else p.set({ fill: 'blue'});  
  }
    
  // Change button color and state of OutputNode to low when mouse is up
  canvas.on('mouse:up', function(e) {
    var p = e.target;
    if( !p || p.name != "button") return;
    p.node.state = low;
    if( isHigh(p.node.state) ) p.set({ fill: 'darkblue'});
    else p.set({ fill: 'blue'});  
  });     
    
  // Control behaviour when moving wire
  canvas.on('object:moving', function(e) {
    var p = e.target;
    if( p.name != "wire") return;
    p.line1.set({ 'x2': p.left, 'y2': p.top });
    // Snap to any node
    for (i = 0; i < elements.length; i++) {
      for (j = 0; j < elements[i].nodes.length; j++) {
        var x1 = elements[i].nodes[j].x1;
        var y1 = elements[i].nodes[j].y1;
        if( Math.abs(p.left - x1 ) < 20 && Math.abs(p.top - y1 ) < 20 ) {
            p.left = x1;
            p.top = y1;
            p.line1.set({ 'x2': x1, 'y2': y1 });
        }
      }
    }
  });
    
  // After moving wire: destroy create new links
  canvas.on('object:moved', function(e) {
    var p = e.target;
    var snapped = false;
    // reset connection wire
    if( p.connection ) p.connection.child = null;
    for (i = 0; i < elements.length; i++) {
      for (j = 0; j < elements[i].nodes.length; j++) {
        var node1 = p.node;
        var node2 = elements[i].nodes[j];
        if( p.left == node2.x1 && p.top == node2.y1 ) {
          if( node1.isInput && !(node2.isInput) && !(node1.child) ) {
            node1.child = node2;
            p.connection = node1;
            p.bringToFront();
            snapped = true;
          }
          if( node2.isInput && !(node1.isInput) && !(node2.child) ) {
            node2.child = node1;
            p.connection = node2;
            p.bringToFront();
            snapped = true;
            // Create extra wire for output node
            makeWire(node1.x1,node1.y1,node1);
          } 
                        
        }
      }
    }
    if( snapped == false ) {
        p.set({ 'left': p.line1.x1, 'top' : p.line1.y1 } );
        p.setCoords();
        p.line1.set({ 'x2': p.line1.x1, 'y2': p.line1.y1 });
    }
  });

})();

</script>
      
  </body>
</html>