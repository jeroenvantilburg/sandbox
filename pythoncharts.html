<!DOCTYPE html>
<html lang="en">
<head>
  <title>Python Charts</title>  

  <script src="https://pyodide-cdn2.iodide.io/v0.15.0/full/pyodide.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.css">
  <style>
  .CodeMirror {
    border: 1px solid #eee;
    /*height: auto;*/
    font-size: 12px;
  }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/mode/javascript/javascript.min.js"></script>
</head>
  
  <body>
    <button id="runCode">Run</button>
    <input id="save-svg" type="button" value="Save as SVG"/>
    <!--button id="save-png">Save as PNG</button-->
    <input id="fileinput" type="file" style="display: none;">
    <button id="stupid_hack" onclick="fileinput.click()">Upload script</button>
    <button id="download">Download script</button>
    width:<input id="width" value="600" type="text" style="width:30px"></input>
    height:<input id="height" value="400" type="text" style="width:30px"></input>

    
    <br/>
    <div id="errorOutput"></div>
        
    <!--textarea rows="20" cols="80" id="codeEditor"></textarea-->
    <div id="codeEditor"></div>
    
     <textarea id='output' style='width: 100%;' rows='10' disabled></textarea>
     <div id="chartOutput" style="width: 600px; height: 400px;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!--script src="https://www.gstatic.com/charts/loader.js"></script-->
    <!--script src="scripts/unicodeTable.js" charset="utf-8"></script--> 
<script>
  
  var myCodeMirror = CodeMirror(document.getElementById("codeEditor"), {
    mode:  "javascript",
    lineNumbers: true
  } );

  const output = document.getElementById("output")

  function addToOutput(s) {
            output.value += `>>>${code.value}\n${s}\n`
            output.scrollTop = output.scrollHeight
            code.value=''
  }
  
  $(document).ready(function() {
    
    //loadScript();
    let code=
`import numpy as np
x = np.linspace(0, 2.0 * np.pi, 100)
y = np.sin(x)
y`;
    code = `print("hello")`;
    myCodeMirror.setValue(code);
    
    
    pyodide.runPython(`
    import sys
    import io
    sys.stdout = io.StringIO()
`);
    
  }); 

  
  function loadScript( url = "demos/combochart.js" ) {
    // Get the file using jQuery get method
    $.get(url, function( code ) { 
      //$("#codeEditor").val(code);
      myCodeMirror.setValue( code );
    });
  }
  
  // Event listener for uploading files
  $("#fileinput").change(function() {
    let files = this.files;
    // Use createObjectURL, this should address any CORS issues.
    let filePath = URL.createObjectURL(files[0]);
    loadScript(filePath);

    // Reset the file input such that it always triggers next change
    this.value = '';
  });

  $("#download").click( function(){
    var filename = prompt("Download as...", "charts.py");
    if (filename != null && filename != "") {
      console.log("filename="+filename);
      let url = 'data:text/plain;charset=utf-8,' + encodeURIComponent( myCodeMirror.getValue() ) ;
      //console.log(url);
      downloadURL( url, filename );
    }
  });

  // Remove focus after enter for all input text elements
  let focusedElement;
  function blurOnEnter(e){ 
    if(e.keyCode===13){ 
      e.target.blur();
      focusedElement = null;
    } 
  }
  $("input[type=text]").on("keydown", blurOnEnter );
  $("input[type=number]").on("keydown", blurOnEnter );

  $("#width").on("change", () => {
    $("#chartOutput").width( $("#width").val() );
    runCode();
  });

  $("#height").on("change", () => {
    $("#chartOutput").height( $("#height").val() );
    runCode();
  });

  
  
  $("#runCode").click( runCode );
      
  
  /*window.onerror = function(msg, url, linenumber) {
    $("#errorOutput").html("Line " + linenumber + ": " + msg ) ;
    return true;
  }*/


  function runCode() {
    let code = myCodeMirror.getValue();
    //clearError();
   
    pyodide.runPythonAsync(code);
                //.then(output => addToOutput(output));
                //.catch((err) => { addToOutput(err) })
        
var stdout = pyodide.runPython("sys.stdout.getvalue()")
var div = document.createElement('div');
div.innerText = stdout;
document.body.appendChild(div);
    /*try {
      $("<script />").html("{"+code+"}").appendTo("head").remove();
       //  eval(code);
    } catch (e) {
      printError( e ); // Maybe this try catch is not needed anymore...
    }*/

  }
  
  function clearError() {
    $("#errorOutput").html('');
  };

  function printError(err) {
    $("#errorOutput").html("Javascript error on line " + err.lineno + ": " + err.message ) ;
  };


  function downloadURL( url, fileName ) {
    var link = document.createElement("a");
    document.body.appendChild(link); // for Firefox
    link.setAttribute("href", url);
    link.setAttribute("download", fileName );
    link.click();
    document.body.removeChild(link);
  }
  
  
  
</script>
    
</body>
</html>
