<!DOCTYPE html>
<html>
<body>

<div style="display: inline-block; margin-left: 10px">
  <button id="dragmode" class="btn btn-info">Dragmode</button>
  <button id="pencil" class="btn btn-info">Pencil</button>
  <button id="pointer" class="btn btn-info">Pointer</button>
  <button id="eraser" class="btn btn-info">Eraser</button>
  <button id="clear-canvas" class="btn btn-info">Clear</button>
  <button id="undo" class="btn btn-info">Undo</button>
  <button id="redo" class="btn btn-info">Redo</button>

  <label for="drawing-line-width">Line width:</label>
  <span class="info">2</span><input type="range" value="2" min="0" max="10" id="drawing-line-width">


  <button id="black" class="btn color" style="background-color:black">B</button>
  <button id="red" class="btn color" style="background-color:red">R</button>
  <button id="green" class="btn color" style="background-color:green">G</button>
  <button id="blue" class="btn color" style="background-color:blue">B</button>


  <label for="drawing-color">Line color:</label>
  <input type="color" value="#000000" id="drawing-color">

  <a href="" onclick="screenshot(this)">Screenshot</a>

  <!--button id="pen">Pen</button>
  <button id="eraser2">Eraser</button-->
  
  </div>
    <script src="scripts/fabric.min.js"></script>
    <script src="scripts/jquery-3.5.0.min.js"></script>

   <div id="canvas1" style="position:relative;width:500px;height:500px;top:0px; left:0px">
      <canvas id="c" width="500" height="500" style="border:1px solid #ccc;
                                                     position: absolute!important;
                                                     left: 0!important;
                                                     top: 0!important;
                                                     width: 100%!important;
                                                     height: 100%!important;">
        Your browser does not support HTML5 Canvas.
      </canvas>
      <canvas id="cursor" width="500" height="500" style="border:1px solid #ccc; 
                                                           position: absolute!important;
                                                           left: 0!important;
                                                           top: 0!important;
                                                           width: 100%!important;
                                                           height: 100%!important;
                                                           pointer-events: none!important;">
     </canvas>
   </div>

<script id="main">
  
  
  //(function() {

  var dom = function(id){return document.getElementById(id)};
  
  var canvas = this.__canvas = new fabric.Canvas('c', {
    isDrawingMode: true,
    redoList: []
  });

  fabric.Object.prototype.transparentCorners = false;
  fabric.Object.prototype.hasControls = false;
  fabric.Object.prototype.hasBorders = false;
  fabric.Object.prototype.padding = 10;

  
  // Eraser stuff
  var cursor = new fabric.StaticCanvas("cursor");
  var cursorOpacity = .3;
  var mousecursor = new fabric.Circle({ 
    left: -100, 
    top: -100, 
    radius: 25, 
    fill: "rgba(0,0,0," + cursorOpacity + ")", 
    strokeWidth: 0,
    stroke: "black",
    originX: 'center', 
    originY: 'center'
  });
  
  var mouseDown = false;  
  
  function erasing(mouse){
    let objects = canvas.getObjects(); //return Array<objects>
    objects.forEach(object=>{
      //object.lockMovementX = true; object.lockMovementY = true
      
      //console.log(object);
      
      var path = object.path;
      object.setCoords();

      var mCanvas = canvas.viewportTransform;
      var mObject = object.calcTransformMatrix();
      //var mTotal = fabric.util.multiplyTransformMatrices(mCanvas, mObject);
      var mInverse = fabric.util.invertTransform(mObject);//mTotal);
      var mouseP = fabric.util.transformPoint(mouse, mInverse);
      mouseP.x += object.pathOffset.x;
      mouseP.y += object.pathOffset.y ;

      //console.log( object.pathOffset.y );
      //console.log( object.translateY );
      //console.log(mouseP.y );
      
      for( i = 0; i < path.length; ++i) {
        var point = { x: path[i][1], y: path[i][2] };
        //var newP = fabric.util.transformPoint(point, object.calcTransformMatrix());
        //console.log(point);
        //console.log(newP);
        if( Math.abs(mouseP.x-point.x) < mousecursor.radius/object.scaleX &&
            Math.abs(mouseP.y-point.y) < mousecursor.radius/object.scaleY ) {
          path[i][0]="M";          
          if( i == 0 && path.length > 1 ) {
            path[i+1][0] = "M";
            //path[i+1].splice(3,2)
          } 
          else if( i == path.length-1 && path.length > 1 ) {
            if( path[i-1] == "Q" ) path[i-1][0] = "L";
          } 
          else {
            if( path[i-1] == "Q" ) path[i-1][0] = "L";
            path[i+1][0] = "M";
          }
        }
        object.dirty = true;
        canvas.requestRenderAll();
      }
      //console.log(path);
   });
  }  
  // end eraser

  function moveCanvas( e ) {
    // Calculate deltas
        let deltaX = 0;
        let deltaY = 0;
        if (lastClientX) {
          deltaX = e.clientX - lastClientX;
        }
        if (lastClientY) {
          deltaY = e.clientY - lastClientY;
        }
        // Update the last X and Y values
        lastClientX = e.clientX;
        lastClientY = e.clientY;

        let delta = new fabric.Point(deltaX, deltaY);
        canvas.relativePan(delta);
        canvas.trigger('moved');
        cursor.relativePan(delta);
        cursor.trigger('moved');
  }


  
  

// Pointer stuff
/*const STATE_IDLE = 'idle';
const STATE_PANNING = 'panning';
fabric.Canvas.prototype.toggleDragMode = function(dragMode) {
  // Remember the previous X and Y coordinates for delta calculations
  let lastClientX;
  let lastClientY;
  // Keep track of the state
  let state = STATE_IDLE;
  // We're entering dragmode
  if (dragMode) {
    // Discard any active object
    this.discardActiveObject();
    // Set the cursor to 'move'
    this.defaultCursor = 'move';
    // Loop over all objects and disable events / selectable. We remember its value in a temp variable stored on each object
    this.forEachObject(function(object) {
      object.prevEvented = object.evented;
      object.prevSelectable = object.selectable;
      object.evented = false;
      object.selectable = false;
    });
    // Remove selection ability on the canvas
    this.selection = false;
    // When MouseUp fires, we set the state to idle
    this.on('mouse:up', function(e) {
      state = STATE_IDLE;
    });
    // When MouseDown fires, we set the state to panning
    this.on('mouse:down', (e) => {
      state = STATE_PANNING;
      lastClientX = e.e.clientX;
      lastClientY = e.e.clientY;
    });
    // When the mouse moves, and we're panning (mouse down), we continue
    this.on('mouse:move', (e) => {
      if (state === STATE_PANNING && e && e.e) {
        // let delta = new fabric.Point(e.e.movementX, e.e.movementY); // No Safari support for movementX and movementY
        // For cross-browser compatibility, I had to manually keep track of the delta

        // Calculate deltas
        let deltaX = 0;
        let deltaY = 0;
        if (lastClientX) {
          deltaX = e.e.clientX - lastClientX;
        }
        if (lastClientY) {
          deltaY = e.e.clientY - lastClientY;
        }
        // Update the last X and Y values
        lastClientX = e.e.clientX;
        lastClientY = e.e.clientY;

        let delta = new fabric.Point(deltaX, deltaY);
        this.relativePan(delta);
        this.trigger('moved');
      }
    });
  } else {
    // When we exit dragmode, we restore the previous values on all objects
    this.forEachObject(function(object) {
      object.evented = (object.prevEvented !== undefined) ? object.prevEvented : object.evented;
      object.selectable = (object.prevSelectable !== undefined) ? object.prevSelectable : object.selectable;
    });
    // Reset the cursor
    this.defaultCursor = 'default';
    // Remove the event listeners
    this.off('mouse:up');
    this.off('mouse:down');
    this.off('mouse:move');
    // Restore selection ability on the canvas
    this.selection = true;
    
  }
};
  */
 
  
  let dragMode = false;
  
  dom('clear-canvas').onclick = function() { canvas.clear() };

  dom('dragmode').onclick = function() {
    //canvas.toggleDragMode(true);
    canvas.isDrawingMode = false;
    canvas.selection = false;
    dragMode = true;
    cursor.remove(mousecursor);
    canvas.hoverCursor = 'move';
    canvas.moveCursor = 'move';
    canvas.defaultCursor = 'move';
    fabric.Object.prototype.selectable = false;
    fabric.Object.prototype.evented = false;

    fabric.Object.prototype.hasControls = false;
    fabric.Object.prototype.hasBorders = false;
    canvas.renderAll();


  }


  
  dom('pointer').onclick = function() {
    canvas.isDrawingMode = false;
    canvas.hoverCursor = 'hover';
    canvas.moveCursor = 'move';
    canvas.defaultCursor = 'default';
    fabric.Object.prototype.selectable = true;
    canvas.selection = true;
    fabric.Object.prototype.evented = true;

    
    cursor.remove(mousecursor);
    //canvas.toggleDragMode(false);
    dragMode = false;

    fabric.Object.prototype.hasControls = true;
    fabric.Object.prototype.hasBorders = true;
    //if (canvas.isDrawingMode) {
    //  dom('pointer').innerHTML = 'Pointer';
    //}
  };

  dom('pencil').onclick = function() {
    canvas.isDrawingMode = true;
    //canvas.toggleDragMode(false);    
    dragMode = false;
    canvas.freeDrawingCursor = 'crosshair';
    cursor.remove(mousecursor);
  };    

  dom('eraser').onclick = function() { 
    canvas.isDrawingMode = false;
    canvas.selection = false;
    canvas.hoverCursor = 'none';
    canvas.moveCursor = 'none';
    canvas.defaultCursor = 'none';
    cursor.add(mousecursor);
    //canvas.toggleDragMode(false);
    dragMode = false;

    fabric.Object.prototype.selectable = false;
    fabric.Object.prototype.evented = false;

    fabric.Object.prototype.hasControls = false;
    fabric.Object.prototype.hasBorders = false;
    canvas.renderAll();

    
  };
  
  dom('drawing-color').onchange = function() {
    var brush = canvas.freeDrawingBrush;
    brush.color = this.value;
    console.log(this.value)
  };

  dom('black').onclick = function() { 
    canvas.freeDrawingBrush.color = "black";
    dom('drawing-color').value = "#000000";
  };
  dom('red').onclick = function() { 
    canvas.freeDrawingBrush.color = "red";
    dom('drawing-color').value = "#FF0000";
  };
  dom('green').onclick = function() { 
    canvas.freeDrawingBrush.color = "green";
    console.log(canvas.freeDrawingBrush.color)
    dom('drawing-color').value = "#00FF00";
  };
  dom('blue').onclick = function() { 
    canvas.freeDrawingBrush.color = "blue";
    dom('drawing-color').value = "#0000FF";
  };

  
  dom('drawing-line-width').onchange = function() {
    canvas.freeDrawingBrush.width = parseInt(this.value, 10) || 1;
    this.previousSibling.innerHTML = this.value;
  };

    
  if (canvas.freeDrawingBrush) {
    canvas.freeDrawingBrush.color = dom('drawing-color').value;
    canvas.freeDrawingBrush.width = parseInt(dom('drawing-line-width').value, 10) || 1;
  }
      
  
  dom('undo').onclick = function() { 
    var canvas_objects = canvas._objects;
    if(canvas_objects.length !== 0){
      var last = canvas_objects[canvas_objects.length -1]; //Get last object
      canvas.redoList.push(last);
      canvas.remove(last);      
      canvas.renderAll();
    }
  }

  dom('redo').onclick = function() { 
    //var canvas_objects = canvas._objects;
    if(canvas.redoList.length !== 0){
      var last = canvas.redoList[canvas.redoList.length -1]; //Get last object
      canvas.add(last);
      canvas.renderAll();
    }
  }

  // update the redo-list
  canvas.on('object:added', function(e) {
    if(canvas.redoList.length !== 0){
      var last = canvas.redoList[canvas.redoList.length -1]; //Get last object
      if(e.target == last) {  
        canvas.redoList.pop();
      } else {
        canvas.redoList = [];
      }
    }
   });
  
  // Remember the previous X and Y coordinates for delta calculations
  let lastClientX;
  let lastClientY;

  
  // Event listener: remove the element
  canvas.on('mouse:up', function(e) {
    mouseDown = false;
  });

  canvas.on('mouse:move', function (evt) {
	  var mouse = this.getPointer(evt.e);
    if( mousecursor.canvas ) {
      mousecursor
        .set({
          top: mouse.y,
          left: mouse.x
         })
        .setCoords()
	      .canvas.renderAll();
      if( mouseDown ) {
        erasing(mouse);
      }
    } else if (dragMode && mouseDown ) {
      moveCanvas( evt.e );
    }
  });
  
  canvas.on('mouse:down', function (evt) {
    mouseDown = true;
    if( mousecursor.canvas ) {
      erasing( this.getPointer(evt.e) );
    } else if( dragMode ) {
      lastClientX = evt.e.clientX;
      lastClientY = evt.e.clientY;
            moveCanvas( evt.e );
    }
  });
  
  canvas.on('mouse:out', function () {
    if( mousecursor.canvas ) {
      // put circle off screen
      mousecursor
        .set({
          top: -10000, //mousecursor.originalState.top,
          left: -10000 //mousecursor.originalState.left
        })
       .setCoords()
       .canvas.renderAll();
    }
  });



// Create the canvas

//let canvas = new fabric.Canvas('fabric')
//canvas.backgroundColor = '#f1f1f1';

// Add a couple of rects

/*let rect = new fabric.Rect({
  width: 100,
  height: 100,
  fill: '#f00'
});
canvas.add(rect)

rect = new fabric.Rect({
  width: 200,
  height: 200,
  top: 200,
  left: 200,
  fill: '#f00'
});
canvas.add(rect)
*/
// Handle dragmode change
//let dragMode = false;
/*dom('dragmode').onclick = function() {
  //dragMode = !dragMode;
  canvas.toggleDragMode(true);
  canvas.isDrawingMode = false;
}*/
  
  // Make a screenshot
  function screenshot(htmlElement) {
    var image = canvas.toDataURL({format: 'png', multiplier: 2});  
    htmlElement.setAttribute("download","screenshot.png");
    htmlElement.setAttribute("href", image);
  }  
    
  // Event listener for resizing the window
  //window.addEventListener('resize', resizeCanvas, false);
  $(window).resize( resizeCanvas );
  function resizeCanvas() {    
    var divCanvas = document.getElementById("canvas1");
    var newWidth = window.innerWidth-20;
    if( newWidth > 100 ) { // minimum size needs to stay at 100px
      divCanvas.style.width = newWidth;
      canvas.setWidth(newWidth);
      canvas.renderAll();
      cursor.setWidth(newWidth);
      cursor.renderAll();
    }
    var newHeight = window.innerHeight-50;
    console.log(newHeight);
    if( newHeight > 100 ) { // minimum size needs to stay at 100px
      divCanvas.style.height = newHeight;
      canvas.setHeight(newHeight);
      canvas.renderAll();
      cursor.setHeight(newHeight);
      cursor.renderAll();
    }

  }
  
  
  //console.log(canvas);
  
  
  // Eraser stuff
  /*var canvas2=dom("c");
var ctx=canvas2.getContext("2d");
var lastX;
var lastY;
var strokeColor="red";
var strokeWidth=5;
var mouseX;
var mouseY;
var canvasOffset=$("#c").offset();
var offsetX=canvasOffset.left;
var offsetY=canvasOffset.top;
var isMouseDown=false;


function handleMouseDown(e){
  mouseX=parseInt(e.clientX-offsetX);
  mouseY=parseInt(e.clientY-offsetY);

  // Put your mousedown stuff here
  lastX=mouseX;
  lastY=mouseY;
  isMouseDown=true;
}

function handleMouseUp(e){
  mouseX=parseInt(e.clientX-offsetX);
  mouseY=parseInt(e.clientY-offsetY);

  // Put your mouseup stuff here
  isMouseDown=false;
}

function handleMouseOut(e){
  mouseX=parseInt(e.clientX-offsetX);
  mouseY=parseInt(e.clientY-offsetY);

  // Put your mouseOut stuff here
  isMouseDown=false;
}

function handleMouseMove(e){
  mouseX=parseInt(e.clientX-offsetX);
  mouseY=parseInt(e.clientY-offsetY);

  // Put your mousemove stuff here
  if(isMouseDown){
    ctx.beginPath();
    if(mode=="pen"){
      ctx.globalCompositeOperation="source-over";
      ctx.moveTo(lastX,lastY);
      ctx.lineTo(mouseX,mouseY);
      ctx.stroke();     
    }else{
      ctx.globalCompositeOperation="destination-out";
      ctx.arc(lastX,lastY,8,0,Math.PI*2,false);
      ctx.fill();
    }
    lastX=mouseX;
    lastY=mouseY;
  }
}

$("#c").mousedown(function(e){handleMouseDown(e);});
$("#c").mousemove(function(e){handleMouseMove(e);});
$("#c").mouseup(function(e){handleMouseUp(e);});
$("#c").mouseout(function(e){handleMouseOut(e);});

var mode="pen";
$("#pen").click(function(){ 
  console.log("pen");
  mode="pen"; });
$("#eraser2").click(function(){
      canvas.isDrawingMode = false;
    console.log("eraser");
  mode="eraser"; });
  
  // end eraser
  */
  
  
  // load all code after the document
  $("document").ready(function(){
    // resize on init
    resizeCanvas();
  });

//})();
   
  </script>

    <noscript>Your browser does not support JavaScript!</noscript>

  
</body>
</html>
