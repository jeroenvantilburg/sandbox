<!DOCTYPE html>
<html>
  <head>
    <style>
      video,
input {
  display: block;
}

input {
  width: 100%;
}

.info {
  background-color: aqua;
}

.error {
  background-color: red;
  color: white;
}
      
    </style>
  </head>
  
<body>

<h1>HTML5 local video file player example</h1>
<div id="message"></div>
  
<input type="file" accept="video/*"/>
<!--video controls height="400"></video-->
  <!--video controls height="400"
         src="file:///Users/jeroen/Downloads/IMG_9460.MOV"></video-->

  
  
  
  <div class="control"><button id="startAndStop" disabled>Start</button></div>
<!--textarea class="code" rows="29" cols="100" id="codeEditor" spellcheck="false">
</textarea-->
</div>
<p class="err" id="errorMessage"></p>
<div>
    <table cellpadding="0" cellspacing="0" width="0" border="0">
    <tr>
        <td>
            <video id="videoInput" width="320" height="568" muted></video>
        </td>
        <td>
            <canvas style="border:1px solid #ccc" id="canvasOutput" width="320" height="568"></canvas>
        </td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>
            <div class="caption">videoInput</div>
        </td>
        <td>
            <div class="caption">canvasOutput</div>
        </td>
        <td></td>
        <td></td>
    </tr>
    </table>
</div>
  
  
  
<!--script src="scripts/opencv.4.5.1.js" type="text/javascript"></script-->  
<script id="main">
function onOpenCvReady() {
    videoInput.addEventListener('canplay', () => {
        startAndStop.removeAttribute('disabled');
    });
    videoInput.src = "file:///Users/jeroen/Downloads/IMG_9460.MOV";
    //videoInput.src = "file:///Users/jeroen/Downloads/cup.mp4";
}
  
function onVideoStarted() {
    streaming = true;
    startAndStop.innerText = 'Stop';
    videoInput.height = videoInput.width * (videoInput.videoHeight / videoInput.videoWidth);
    //utils.executeCode('codeEditor');
  
  
let video = document.getElementById('videoInput');
let cap = new cv.VideoCapture(video);

// take first frame of the video
let frame = new cv.Mat(video.height, video.width, cv.CV_8UC4);
cap.read(frame);

// hardcode the initial location of window
//let trackWindow = new cv.Rect(150, 60, 63, 125);
//let x1 = 200, y1=0, x2=250, y2=60;
let trackWindow = new cv.Rect(120, 0, 100, 50);


// set up the ROI for tracking
let roi = frame.roi(trackWindow);
let hsvRoi = new cv.Mat();
cv.cvtColor(roi, hsvRoi, cv.COLOR_RGBA2RGB);
cv.cvtColor(hsvRoi, hsvRoi, cv.COLOR_RGB2HSV);
let mask = new cv.Mat();
let lowScalar = new cv.Scalar(30, 30, 0);
let highScalar = new cv.Scalar(180, 180, 180);
let low = new cv.Mat(hsvRoi.rows, hsvRoi.cols, hsvRoi.type(), lowScalar);
let high = new cv.Mat(hsvRoi.rows, hsvRoi.cols, hsvRoi.type(), highScalar);
cv.inRange(hsvRoi, low, high, mask);
let roiHist = new cv.Mat();
let hsvRoiVec = new cv.MatVector();
hsvRoiVec.push_back(hsvRoi);
cv.calcHist(hsvRoiVec, [0], mask, roiHist, [180], [0, 180]);
cv.normalize(roiHist, roiHist, 0, 255, cv.NORM_MINMAX);

// delete useless mats.
roi.delete(); hsvRoi.delete(); mask.delete(); low.delete(); high.delete(); hsvRoiVec.delete();

// Setup the termination criteria, either 10 iteration or move by atleast 1 pt
let termCrit = new cv.TermCriteria(cv.TERM_CRITERIA_EPS | cv.TERM_CRITERIA_COUNT, 10, 1);

let hsv = new cv.Mat(video.height, video.width, cv.CV_8UC3);
let hsvVec = new cv.MatVector();
hsvVec.push_back(hsv);
let dst = new cv.Mat();
let trackBox = null;

const FPS = 60;
function processVideo() {
  console.log("tot hier 1");
  //console.log(video.presentedFrames);
    try {
  console.log("tot hier 2");

        if (!streaming) {
            console.log("tot hier 3");

            // clean and stop.
            frame.delete(); dst.delete(); hsvVec.delete(); roiHist.delete(); hsv.delete();
            return;
        }
        let begin = Date.now();
  console.log(begin);


        // start processing.
        cap.read(frame);
        cv.cvtColor(frame, hsv, cv.COLOR_RGBA2RGB);
        cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);
        cv.calcBackProject(hsvVec, [0], roiHist, dst, [0, 180], 1);

        // apply camshift to get the new location
        /*[trackBox, trackWindow] = cv.CamShift(dst, trackWindow, termCrit);
            
        // Draw it on image
        let pts = cv.rotatedRectPoints(trackBox);
        //let trackWindow = new cv.Rect(150, 60, 63, 125);
        //let x1 = 200, y1=0, x2=250, y2=60;
        //pts = [{x: x1, y: y1}, {x: x2, y: y1}, {x: x2, y: y2}, {x: x1, y: y2}]
        //console.log(pts);

        cv.line(frame, pts[0], pts[1], [255, 0, 0, 255], 3);
        cv.line(frame, pts[1], pts[2], [255, 0, 0, 255], 3);
        cv.line(frame, pts[2], pts[3], [255, 0, 0, 255], 3);
        cv.line(frame, pts[3], pts[0], [255, 0, 0, 255], 3);
        cv.imshow('canvasOutput', frame);
        */

        // apply meanshift instead
        [, trackWindow] = cv.meanShift(dst, trackWindow, termCrit);

        // Draw it on image
        let [x, y, w, h] = [trackWindow.x, trackWindow.y, trackWindow.width, trackWindow.height];
        cv.rectangle(frame, new cv.Point(x, y), new cv.Point(x+w, y+h), [255, 0, 0, 255], 2);
        cv.imshow('canvasOutput', frame);

        console.log(videoInput.currentTime);
        videoInput.currentTime = Math.min(videoInput.duration, videoInput.currentTime + 1/FPS);
      
         
      
        // schedule the next one.
        let delay = 1000/FPS - (Date.now() - begin);
        setTimeout(processVideo, 10 );//delay);
    } catch (err) {
        //utils.printError(err);
    }
};

videoInput.currentTime = 0.5/FPS;
  
// schedule the first one.
setTimeout(processVideo, 0);
}
  
  </script>

  
  
  
<script type="text/javascript">
//let utils = new Utils('errorMessage');

//utils.loadCode('codeSnippet', 'codeEditor');

let streaming = false;
let videoInput = document.getElementById('videoInput');
let startAndStop = document.getElementById('startAndStop');
let canvasOutput = document.getElementById('canvasOutput');
let canvasContext = canvasOutput.getContext('2d');

startAndStop.addEventListener('click', () => {
    if (!streaming) {
        //utils.clearError();
        //videoInput.play().then(() => {
        videoInput.pause();
            onVideoStarted();
        //});
    } else {
        videoInput.pause();
        videoInput.currentTime = 0;
        onVideoStopped();
    }
});

function onVideoStopped() {
    streaming = false;
    canvasContext.clearRect(0, 0, canvasOutput.width, canvasOutput.height);
    startAndStop.innerText = 'Start';
}
  
</script>

<script async src="scripts/opencv.3.4.0.js" onload="onOpenCvReady();" type="text/javascript"></script>  
  

<!--script id="main">
  
(function localFileVideoPlayer() {
  'use strict'
  var URL = window.URL || window.webkitURL
  var displayMessage = function(message, isError) {
    var element = document.querySelector('#message')
    element.innerHTML = message
    element.className = isError ? 'error' : 'info'
  }
  var playSelectedFile = function(event) {
    var file = this.files[0]
    var type = file.type
    var videoNode = document.querySelector('video')
    var canPlay = videoNode.canPlayType(type)
    if (canPlay === '') canPlay = 'no'
    var message = 'Can play type "' + type + '": ' + canPlay
    var isError = canPlay === 'no'
    displayMessage(message, isError)

    if (isError) {
      return
    }

    var fileURL = URL.createObjectURL(file)
    videoNode.src = fileURL
  }
  var inputNode = document.querySelector('input')
  inputNode.addEventListener('change', playSelectedFile, false)
})()
  
  </script-->
  
</body>
</html>
