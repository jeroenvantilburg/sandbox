<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.17.0/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.css">
  <style>
  .CodeMirror {
    border: 1px solid #eee;
    /*height: auto;
    width: 50%;*/
    height: 500px;
    font-size: 12px;
  }
  #wrapper{ width: 100%; height: 560px; display: flex; }
  #codeEditor{ width: 50%; } 
  #pyplotdiv{ width: 50%; }
  </style>
  <link rel="stylesheet" 
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/mode/python/python.min.js"></script>
</head>

<body>
  <div id="wrapper">
  <!--input id='code' value='sum([1, 2, 3, 4, 5])'-->
    <div id="codeEditor">
      <p>You can execute any Python code. Just enter something in the box below and click the button.</p>
    </div>
    <div id="pyplotdiv">
      <!--div id="matplotfigure"></div>
      <img id="pyplotfigure"/-->
    </div>
  </div>

  <button onclick='evaluatePython()'>Run</button>
  <br>
  <br>
  <div>
    Output:
  </div>
  <textarea id='output' style='width: 100%;' rows='10' disabled></textarea>

  
  <script>
    
  var myCodeMirror = CodeMirror(document.getElementById("codeEditor"), {
    mode:  "python",
    lineNumbers: true
  } );

    
    const output = document.getElementById("output");
    //const code = document.getElementById("code");
    
        let code=
`import numpy as np
x = np.linspace(0, 2.0 * np.pi, 100)
y = np.sin(x)
y`;
    //code = `sum([1, 2, 3, 4, 5])`;

    // Example with downloading raw png image
    code=
`import matplotlib.pyplot as plt

fig, ax = plt.subplots()
ax.plot([1,3,2])

import io, base64
buf = io.BytesIO()
fig.savefig(buf, format='png')
buf.seek(0)
img_str = 'data:image/png;base64,' + base64.b64encode(buf.read()).decode('UTF-8')
`
    code=
`import matplotlib.pyplot as plt

fig, ax = plt.subplots()
ax.plot([1,3,2])
fig.show()
`
    myCodeMirror.setValue(code);
   
    let lastID;

    function addToOutput(s) {
      // Use the built-in show() method
/*      pyodide.runPython(`
from matplotlib.backends import backend_agg
#if "pyodide" in sys.modules:
#    from js import document, ImageData
from js import document
f = plt.gcf()

#override create_root_element method of canvas by one of the functions above
f.canvas.create_root_element = create_root_element1.__get__(f.canvas, f.canvas.__class__)

print('showing')
f.canvas.show()
print('done')
      `);
*/
      pyodide.runPython(`
f = plt.gcf()
f.canvas.create_root_element = create_root_element1.__get__(f.canvas, f.canvas.__class__)
#print('showing')
f.canvas.show()
#print('done')
#print('id: ' + f.canvas._id )
lastID = f.canvas._id
      `);

      lastID = pyodide.globals.get('lastID')

      //pyodide.runPython("sys.stdout.flush()")
      var stdout = pyodide.runPython("sys.stdout.getvalue()")
      pyodide.runPython("sys.stdout = io.StringIO()"); // clear stdout
      output.value += stdout;
      
      if( s ) output.value += s + '\n';//'>>>' + code.value + '\n' + s + '\n';

      // Move to last line
      output.scrollTop = output.scrollHeight;
      
      // Requires code to have a img_str variable
      //document.getElementById("pyplotfigure").src=pyodide.globals.img_str;

    }

    output.value = 'Initializing...\n';
    // init Pyodide
    async function main(){
      await loadPyodide({ indexURL : 'https://cdn.jsdelivr.net/pyodide/v0.17.0/full/' });

      // Redirect IO to stdout
      pyodide.runPython(`
import sys, io
sys.stdout = io.StringIO()
`);

      pyodide.runPython(`
def create_root_element1(self):
    #print('my create_root_element!')
    div = document.createElement('div')
    #document.body.appendChild(div)
    document.getElementById("pyplotdiv").appendChild(div)
    #div = document.getElementById("pyplotdiv")
    return div
`);
      await pyodide.runPythonAsync(`
import matplotlib.pyplot as plt
from matplotlib.backends import backend_agg
from js import document
#f = plt.gcf()

#override create_root_element method of canvas by one of the functions above
#f.canvas.create_root_element = create_root_element1.__get__(f.canvas, f.canvas.__class__)
`);
      
      output.value += 'Ready!\n';
    }
    let pyodideReadyPromise = main();

    async function evaluatePython() {

      // Remove the previous div first
      if( lastID ) {
        document.getElementById(lastID).remove();
      }

      await pyodideReadyPromise;
      try {
        let output = await pyodide.runPythonAsync( myCodeMirror.getValue() );
        addToOutput(output);
      } catch(err) {
        addToOutput(err);
      }
    }
  </script>
</body>

</html>

